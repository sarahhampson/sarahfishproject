# Function to get presence|absence data on taxa from relative abundance matrices
# And to include if that sqID and year are associated with novelty

# Input the relative abundance matrices and novelty results
add.presence.absence <- function(relA_matrices, novresults){
  
  # Store name of matrix
  name <- names(relA_matrices[x])
  
  # Filter results to just sqID, Year and novel=T/F
  to_merge <- novresults %>% 
    dplyr::select(sqID, bins, novel)
  
  # Loop through matrix list to get species, pres/abs and community ID
  pres_abs_list <- lapply(relA_matrices, function(x){
    
     # Remove first 5 time bins from matrix
    x <- x[-(1:5),]
    
    # Turn matrix into dataframe
    x <- as.data.frame(x)
    
    # Turn to long format
    x <- pivot_longer(x, cols=everything(), names_to="Species", values_to="relA")
    
    # Add presence/absence and sqID
    x <- x %>% mutate(presence = ifelse(relA>0, 1, 0),
                      sqID = name)
    
    
    
    })
  })
  
}
    
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  species,
                                 abundance_matrices,
                                 survey_data,
                                 nov_results.df){
  
# Lets look at just "Salmo trutta"
#species = "Salmo trutta"
#survey_data = v2_survey_data
#abundance_matrices = taxonomic_matrix_list
#nov_results.df = v2.tax.results.df
  
# Make list of sqIDs in which species appears
species.sqIDS <- survey_data %>% 
  mutate(sqIDs = paste0(TimeSeriesID, " Q", Quarter),           
         speciespresent = ifelse(Species==species, 1, 0)) %>%
  filter(speciespresent == 1)

# Filter results list for only these sqIDs
species.results <- subset(nov_results.df, nov_results.df$site %in% species.sqIDS$sqIDs)

# Set index for rows
species.results <- species.results %>% 
  mutate(index = rownames(species.results)) %>% separate(index, into = c("First", "row"), "[.]") %>%
  dplyr::select(-First)

# Filter tax_matrix_list for only those sqIDs
species.matrices <- taxonomic_matrix_list[names(taxonomic_matrix_list) %in% species.sqIDS$sqIDs]

# Create empty dataframe
species.PA <- data.frame()

# Loop through matrices list for presence/absence data
for(i in 1:length(species.matrices)){
  # Change values greater than zero to 1
  species.matrices[[i]][species.matrices[[i]]>0] <- 1
  #print(names(salmotrutta.matrices[i]))
  #print(salmotrutta.matrices[[i]])
  # Get the row values from dataframe where the sqID column equals the name of our matrix
  rowValues <- subset(species.results, species.results$sqID == names(species.matrices[i]))['row']
  for (j in 1:nrow(rowValues)){
    present = ifelse(species.matrices[[i]][as.numeric(rowValues$row[j]),species]==1, 1, 0)
    absent = ifelse(salmotrutta.matrices[[i]][as.numeric(rowValues$row[j]),species]==0, 1, 0)
    df.temp = data.frame(present, absent)
    df.temp$sqID <- names(species.matrices[i])
    df.temp$row <- rowValues$row[j]
    #print(df.temp)
    species.PA <- rbind(species.PA, df.temp)
  }
  
# Now merge the presence absence df with the novelty results
output <- merge(species.results, species.PA, by=c("sqID", "row"))
}
  return(output)
}
